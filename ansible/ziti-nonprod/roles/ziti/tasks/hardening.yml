---
# =============================================================================
# Security Hardening
# =============================================================================

- name: Disable password authentication for SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  notify: restart sshd

- name: Disable root login via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: restart sshd

- name: Install fail2ban
  yum:
    name: fail2ban
    state: present
  ignore_errors: yes

- name: Configure fail2ban for SSH
  copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/secure
      maxretry = 3
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban
  ignore_errors: yes

- name: Enable fail2ban
  systemd:
    name: fail2ban
    enabled: yes
    state: started
  ignore_errors: yes

- name: Set restrictive umask
  lineinfile:
    path: /etc/profile
    regexp: '^umask'
    line: 'umask 027'
    state: present

- name: Disable unnecessary services
  systemd:
    name: "{{ item }}"
    enabled: no
    state: stopped
  loop:
    - postfix
    - rpcbind
  ignore_errors: yes

- name: Ensure Ziti files have correct ownership
  file:
    path: "{{ ziti_home }}"
    state: directory
    recurse: yes
    owner: "{{ ziti_user }}"
    group: "{{ ziti_group }}"

