# =============================================================================
# Ziti Role - PKI Tasks
# =============================================================================
# Creates the full multi-level CA hierarchy required for Ziti v1.6+
#
# PKI Structure:
#   theraprac-root/                 - Root CA
#   theraprac-external-ica/         - External Intermediate CA
#   theraprac-network-ica/          - Network Components ICA (controller fabric)
#   theraprac-edge-ica/             - Edge ICA (web API - signs JWTs!)
#   theraprac-sign-ica/             - Signing ICA (enrollment)
# =============================================================================

---
# =============================================================================
# Root CA
# =============================================================================
- name: Check if Root CA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_root_ca }}/certs/{{ ziti_pki_root_ca }}.cert"
  register: root_ca_stat

- name: Create Root CA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create ca
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_root_ca }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_root_ca }}/certs/{{ ziti_pki_root_ca }}.cert"
  when: not root_ca_stat.stat.exists

# =============================================================================
# External Intermediate CA (signed by Root)
# =============================================================================
- name: Check if External ICA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_external_ica }}/certs/{{ ziti_pki_external_ica }}.cert"
  register: external_ica_stat

- name: Create External Intermediate CA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create intermediate
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_root_ca }}
      --intermediate-name {{ ziti_pki_external_ica }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_external_ica }}/certs/{{ ziti_pki_external_ica }}.cert"
  when: not external_ica_stat.stat.exists

# =============================================================================
# Network Components ICA (for controller fabric identity)
# =============================================================================
- name: Check if Network ICA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/certs/{{ ziti_pki_network_ica }}.cert"
  register: network_ica_stat

- name: Create Network Components ICA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create intermediate
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_external_ica }}
      --intermediate-name {{ ziti_pki_network_ica }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/certs/{{ ziti_pki_network_ica }}.cert"
  when: not network_ica_stat.stat.exists

- name: Create Network server certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create server
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_network_ica }}
      --server-name network-server
      --dns localhost,{{ ziti_public_endpoint }}
      --ip 127.0.0.1
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/certs/network-server.cert"

- name: Create Network client certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create client
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_network_ica }}
      --client-name network-client
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/certs/network-client.cert"

# =============================================================================
# Edge ICA (for web/edge API - THIS SIGNS THE JWTs!)
# =============================================================================
- name: Check if Edge ICA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/certs/{{ ziti_pki_edge_ica }}.cert"
  register: edge_ica_stat

- name: Create Edge ICA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create intermediate
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_external_ica }}
      --intermediate-name {{ ziti_pki_edge_ica }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/certs/{{ ziti_pki_edge_ica }}.cert"
  when: not edge_ica_stat.stat.exists

- name: Create Edge server certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create server
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_edge_ica }}
      --server-name edge-server
      --dns localhost,{{ ziti_public_endpoint }}
      --ip 127.0.0.1
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/certs/edge-server.cert"

- name: Create Edge client certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create client
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_edge_ica }}
      --client-name edge-client
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/certs/edge-client.cert"

# =============================================================================
# Signing ICA (for enrollment signingCert)
# =============================================================================
- name: Check if Sign ICA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_sign_ica }}/certs/{{ ziti_pki_sign_ica }}.cert"
  register: sign_ica_stat

- name: Create Signing ICA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create intermediate
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_external_ica }}
      --intermediate-name {{ ziti_pki_sign_ica }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_sign_ica }}/certs/{{ ziti_pki_sign_ica }}.cert"
  when: not sign_ica_stat.stat.exists

# =============================================================================
# Create CA Chain Files (required for controller config)
# =============================================================================
- name: Create Network ICA full CA chain
  ansible.builtin.shell: |
    cat "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/certs/{{ ziti_pki_network_ica }}.chain.pem" \
        "{{ ziti_pki_dir }}/{{ ziti_pki_external_ica }}/certs/{{ ziti_pki_external_ica }}.chain.pem" \
        "{{ ziti_pki_dir }}/{{ ziti_pki_root_ca }}/certs/{{ ziti_pki_root_ca }}.cert" \
        > "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/cas-full.pem"
  args:
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_network_ica }}/cas-full.pem"

- name: Create Edge ICA full CA chain
  ansible.builtin.shell: |
    cat "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/certs/{{ ziti_pki_edge_ica }}.chain.pem" \
        "{{ ziti_pki_dir }}/{{ ziti_pki_external_ica }}/certs/{{ ziti_pki_external_ica }}.chain.pem" \
        "{{ ziti_pki_dir }}/{{ ziti_pki_root_ca }}/certs/{{ ziti_pki_root_ca }}.cert" \
        > "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/edge.cas-full.pem"
  args:
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_edge_ica }}/edge.cas-full.pem"

# =============================================================================
# Set Permissions
# =============================================================================
- name: Set PKI directory ownership
  ansible.builtin.file:
    path: "{{ ziti_pki_dir }}"
    owner: root
    group: root
    recurse: true

- name: Find all key files
  ansible.builtin.find:
    paths: "{{ ziti_pki_dir }}"
    patterns: "*.key"
    recurse: true
  register: key_files

- name: Set key permissions (600)
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: '0600'
  loop: "{{ key_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Display PKI structure
  ansible.builtin.command:
    cmd: find {{ ziti_pki_dir }} -type f \( -name "*.cert" -o -name "*.pem" \) | sort
  register: pki_files
  changed_when: false

- name: Show PKI files created
  ansible.builtin.debug:
    msg: "{{ pki_files.stdout_lines }}"
