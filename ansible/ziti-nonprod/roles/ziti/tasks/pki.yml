# =============================================================================
# Ziti Role - PKI Tasks
# =============================================================================
# Creates PKI certificates for Ziti controller and router
# =============================================================================

---
- name: Check if Root CA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_ca_name }}/certs/{{ ziti_pki_ca_name }}.cert"
  register: root_ca_stat

- name: Create Root CA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create ca
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_ca_name }}
      --ca-file {{ ziti_pki_ca_name }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_ca_name }}/certs/{{ ziti_pki_ca_name }}.cert"
  when: not root_ca_stat.stat.exists

- name: Check if Intermediate CA exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_intermediate_name }}.cert"
  register: intermediate_ca_stat

- name: Create Intermediate CA
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create intermediate
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_ca_name }}
      --intermediate-name {{ ziti_pki_intermediate_name }}
      --intermediate-file {{ ziti_pki_intermediate_name }}
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_intermediate_name }}.cert"
  when: not intermediate_ca_stat.stat.exists

- name: Check if Server certificate exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_server_name }}-server.cert"
  register: server_cert_stat

- name: Create Server certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create server
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_intermediate_name }}
      --server-name {{ ziti_pki_server_name }}
      --server-file {{ ziti_pki_server_name }}-server
      --dns {{ ziti_public_endpoint }},{{ ziti_private_dns_name }},localhost
      --ip 127.0.0.1
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_server_name }}-server.cert"
  when: not server_cert_stat.stat.exists

- name: Check if Client certificate exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_server_name }}-client.cert"
  register: client_cert_stat

- name: Create Client certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} pki create client
      --pki-root {{ ziti_pki_dir }}
      --ca-name {{ ziti_pki_intermediate_name }}
      --client-name {{ ziti_pki_server_name }}
      --client-file {{ ziti_pki_server_name }}-client
    creates: "{{ ziti_pki_dir }}/{{ ziti_pki_intermediate_name }}/certs/{{ ziti_pki_server_name }}-client.cert"
  when: not client_cert_stat.stat.exists

- name: Set PKI directory ownership
  ansible.builtin.file:
    path: "{{ ziti_pki_dir }}"
    owner: root
    group: root
    recurse: true

- name: Find all certificate files
  ansible.builtin.find:
    paths: "{{ ziti_pki_dir }}"
    patterns: "*.cert"
    recurse: true
  register: cert_files

- name: Set certificate permissions (644)
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: '0644'
  loop: "{{ cert_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Find all key files
  ansible.builtin.find:
    paths: "{{ ziti_pki_dir }}"
    patterns: "*.key"
    recurse: true
  register: key_files

- name: Set key permissions (600)
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: '0600'
  loop: "{{ key_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Display PKI structure
  ansible.builtin.command:
    cmd: find {{ ziti_pki_dir }} -type f \( -name "*.cert" -o -name "*.key" \)
  register: pki_files
  changed_when: false

- name: Show PKI files
  ansible.builtin.debug:
    msg: "{{ pki_files.stdout_lines }}"
