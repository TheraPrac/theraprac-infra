---
# =============================================================================
# PKI Generation
# =============================================================================

- name: Check if root CA already exists
  stat:
    path: "{{ ziti_home }}/pki/root/root-ca.cert"
  register: root_ca_exists

- name: Generate Root CA
  when: not root_ca_exists.stat.exists
  block:
    - name: Create Root CA
      command: >
        {{ ziti_home }}/bin/ziti pki create ca
        --pki-root {{ ziti_home }}/pki/root
        --ca-name root-ca
        --ca-file root-ca
        --trust-domain theraprac.{{ environment }}
      become_user: "{{ ziti_user }}"

- name: Check if intermediate CA exists
  stat:
    path: "{{ ziti_home }}/pki/intermediate/intermediate-ca.cert"
  register: intermediate_ca_exists

- name: Generate Intermediate CA
  when: not intermediate_ca_exists.stat.exists
  block:
    - name: Create Intermediate CA
      command: >
        {{ ziti_home }}/bin/ziti pki create intermediate
        --pki-root {{ ziti_home }}/pki/root
        --ca-name root-ca
        --intermediate-name intermediate-ca
        --intermediate-file {{ ziti_home }}/pki/intermediate/intermediate-ca
      become_user: "{{ ziti_user }}"

- name: Check if server cert exists
  stat:
    path: "{{ ziti_home }}/pki/server/server.cert"
  register: server_cert_exists

- name: Generate Server Certificate
  when: not server_cert_exists.stat.exists
  block:
    - name: Create Server Certificate
      command: >
        {{ ziti_home }}/bin/ziti pki create server
        --pki-root {{ ziti_home }}/pki/root
        --ca-name root-ca
        --server-name server
        --server-file {{ ziti_home }}/pki/server/server
        --dns {{ ziti_domain }},localhost
        --ip 127.0.0.1
      become_user: "{{ ziti_user }}"

- name: Create CA bundle
  shell: |
    cat {{ ziti_home }}/pki/root/root-ca.cert \
        {{ ziti_home }}/pki/intermediate/intermediate-ca.cert \
        > {{ ziti_home }}/pki/ca-bundle.cert
  args:
    creates: "{{ ziti_home }}/pki/ca-bundle.cert"
  become_user: "{{ ziti_user }}"

- name: Set strict permissions on PKI files
  file:
    path: "{{ ziti_home }}/pki"
    state: directory
    recurse: yes
    owner: "{{ ziti_user }}"
    group: "{{ ziti_group }}"
    mode: 'u=rwX,g=rX,o='

