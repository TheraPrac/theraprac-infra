# =============================================================================
# Ziti Role - PKI Generation Tasks
# =============================================================================
# Generates PKI certificates for Ziti controller and router.
# Uses the Ziti CLI's built-in PKI commands.
# =============================================================================

---
- name: Check if root CA already exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/root-ca/certs/root-ca.cert"
  register: root_ca_exists

- name: Generate root CA
  ansible.builtin.command:
    cmd: >
      {{ ziti_home }}/bin/ziti pki create ca
      --pki-root {{ ziti_pki_dir }}
      --ca-name root-ca
      --ca-file root-ca
  become_user: "{{ ziti_user }}"
  when: not root_ca_exists.stat.exists
  # TODO: Consider setting appropriate validity period

- name: Check if server certificate already exists
  ansible.builtin.stat:
    path: "{{ ziti_pki_dir }}/root-ca/certs/server.cert"
  register: server_cert_exists

- name: Generate server certificate
  ansible.builtin.command:
    cmd: >
      {{ ziti_home }}/bin/ziti pki create server
      --pki-root {{ ziti_pki_dir }}
      --ca-name root-ca
      --server-name server
      --server-file server
      --dns {{ ziti_domain }},localhost
      --ip 127.0.0.1
  become_user: "{{ ziti_user }}"
  when: not server_cert_exists.stat.exists
  # TODO: Add any additional DNS names or IPs needed

- name: Set PKI directory permissions
  ansible.builtin.file:
    path: "{{ ziti_pki_dir }}"
    state: directory
    owner: "{{ ziti_user }}"
    group: "{{ ziti_group }}"
    mode: '0750'
    recurse: true

- name: Set private key permissions
  ansible.builtin.shell:
    cmd: find {{ ziti_pki_dir }} -name "*.key" -exec chmod 600 {} \;
  changed_when: false
  # TODO: Use ansible.builtin.find + ansible.builtin.file for idempotency

- name: Display PKI structure
  ansible.builtin.command:
    cmd: find {{ ziti_pki_dir }} -type f -name "*.cert" -o -name "*.key"
  register: pki_files
  changed_when: false

- name: Show generated PKI files
  ansible.builtin.debug:
    msg: "{{ pki_files.stdout_lines }}"
