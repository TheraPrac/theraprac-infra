# =============================================================================
# Ziti Role - SSH Key Management
# =============================================================================
# Adds authorized SSH keys for admin access via Ziti overlay.
# Keys are defined in defaults/main.yml or passed as variables.
#
# NOTE: Primary SSH key injection happens via Terraform user_data at boot.
# This task is for adding additional keys or updating existing instances.
# =============================================================================

---
- name: Ensure .ssh directory exists for ansible user
  ansible.builtin.file:
    path: /home/ansible/.ssh
    state: directory
    owner: ansible
    group: ansible
    mode: '0700'

- name: Add authorized SSH keys for ansible user
  ansible.builtin.authorized_key:
    user: ansible
    key: "{{ item }}"
    state: present
  loop: "{{ ziti_authorized_ssh_keys }}"
  when: ziti_authorized_ssh_keys is defined and ziti_authorized_ssh_keys | length > 0

- name: Ensure .ssh directory exists for jfinlinson user
  ansible.builtin.file:
    path: /home/jfinlinson/.ssh
    state: directory
    owner: jfinlinson
    group: jfinlinson
    mode: '0700'

- name: Add authorized SSH keys for jfinlinson user
  ansible.builtin.authorized_key:
    user: jfinlinson
    key: "{{ item }}"
    state: present
  loop: "{{ ziti_authorized_ssh_keys_admin | default(ziti_authorized_ssh_keys) }}"
  when: (ziti_authorized_ssh_keys_admin is defined and ziti_authorized_ssh_keys_admin | length > 0) or 
        (ziti_authorized_ssh_keys is defined and ziti_authorized_ssh_keys | length > 0)
