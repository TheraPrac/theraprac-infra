---
# =============================================================================
# Systemd Services Setup
# =============================================================================
# Note: Controller is started first, then router enrollment happens in router.yml,
# then router service is started here.

- name: Create ziti-controller systemd service
  template:
    src: ziti-controller.service.j2
    dest: /etc/systemd/system/ziti-controller.service
    owner: root
    group: root
    mode: '0644'
  notify: reload systemd

- name: Create ziti-router systemd service
  template:
    src: ziti-router.service.j2
    dest: /etc/systemd/system/ziti-router.service
    owner: root
    group: root
    mode: '0644'
  notify: reload systemd

- name: Create ziti-healthcheck systemd service
  template:
    src: ziti-healthcheck.service.j2
    dest: /etc/systemd/system/ziti-healthcheck.service
    owner: root
    group: root
    mode: '0644'
  notify: reload systemd

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start ziti-controller
  systemd:
    name: ziti-controller
    enabled: yes
    state: started

- name: Wait for controller to be ready before continuing
  uri:
    url: "https://127.0.0.1:{{ ziti_controller_port }}/edge/client/v1/version"
    validate_certs: no
    status_code: 200
  register: controller_ready
  retries: 30
  delay: 5
  until: controller_ready.status == 200

# Note: Router service is started in main.yml after enrollment

- name: Enable and start ziti-healthcheck
  systemd:
    name: ziti-healthcheck
    enabled: yes
    state: started

