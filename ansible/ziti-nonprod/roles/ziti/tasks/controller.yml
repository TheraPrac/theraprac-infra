# =============================================================================
# Ziti Role - Controller Tasks
# =============================================================================
# Configures the Ziti controller
# =============================================================================

---
- name: Deploy controller configuration
  ansible.builtin.template:
    src: controller.yaml.j2
    dest: "{{ ziti_controller_dir }}/controller.yaml"
    owner: root
    group: root
    mode: '0640'
  notify: restart ziti-controller

- name: Check if controller database exists
  ansible.builtin.stat:
    path: "{{ ziti_controller_dir }}/ctrl.db"
  register: controller_db_stat

- name: Generate admin password
  ansible.builtin.set_fact:
    ziti_admin_password: "{{ lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=32') }}"
  when: not controller_db_stat.stat.exists

- name: Initialize controller
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} controller edge init
      {{ ziti_controller_dir }}/controller.yaml
      --username {{ ziti_admin_user }}
      --password "{{ ziti_admin_password }}"
    creates: "{{ ziti_controller_dir }}/ctrl.db"
  when: not controller_db_stat.stat.exists
  register: controller_init
  no_log: true

- name: Save admin password to file
  ansible.builtin.copy:
    content: "{{ ziti_admin_password }}"
    dest: "{{ ziti_admin_password_file }}"
    owner: root
    group: root
    mode: '0600'
  when: controller_init is changed
  no_log: true

- name: Read admin password from file
  ansible.builtin.slurp:
    src: "{{ ziti_admin_password_file }}"
  register: admin_password_content
  when: controller_db_stat.stat.exists

- name: Set admin password fact from file
  ansible.builtin.set_fact:
    ziti_admin_password: "{{ admin_password_content.content | b64decode }}"
  when: controller_db_stat.stat.exists
  no_log: true

- name: Display admin credentials location
  ansible.builtin.debug:
    msg: "Admin password stored at: {{ ziti_admin_password_file }}"
