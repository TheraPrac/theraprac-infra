# =============================================================================
# Ziti Role - Router Tasks
# =============================================================================
# Configures and enrolls the Ziti router
# =============================================================================

---
- name: Deploy router configuration
  ansible.builtin.template:
    src: router.yaml.j2
    dest: "{{ ziti_router_dir }}/router.yaml"
    owner: root
    group: root
    mode: '0640'
  notify: restart ziti-router

- name: Check if router is already enrolled
  ansible.builtin.stat:
    path: "{{ ziti_router_dir }}/{{ ziti_router_name }}.cert"
  register: router_cert_stat

# The following tasks only run if router is not enrolled
- name: Ensure controller service is started for enrollment
  ansible.builtin.systemd:
    name: ziti-controller
    state: started
    enabled: true
  when: not router_cert_stat.stat.exists

- name: Wait for controller to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ ziti_controller_port }}"
    timeout: 120
  when: not router_cert_stat.stat.exists

- name: Read admin password for enrollment
  ansible.builtin.slurp:
    src: "{{ ziti_admin_password_file }}"
  register: admin_password_for_router
  when: not router_cert_stat.stat.exists
  no_log: true

- name: Set admin password fact
  ansible.builtin.set_fact:
    ziti_admin_password: "{{ admin_password_for_router.content | b64decode }}"
  when: not router_cert_stat.stat.exists
  no_log: true

- name: Login to controller
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} edge login
      https://127.0.0.1:{{ ziti_controller_port }}
      --yes
      --username {{ ziti_admin_user }}
      --password "{{ ziti_admin_password }}"
  environment:
    ZITI_CTRL_EDGE_ADVERTISED_HOST: "{{ ziti_public_endpoint }}"
  when: not router_cert_stat.stat.exists
  no_log: true
  changed_when: true

- name: Check if router exists in controller
  ansible.builtin.command:
    cmd: "{{ ziti_bin }} edge list edge-routers 'name=\"{{ ziti_router_name }}\"' --output-json"
  register: router_list
  when: not router_cert_stat.stat.exists
  changed_when: false
  failed_when: false

- name: Create edge router in controller
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} edge create edge-router {{ ziti_router_name }}
      --jwt-output-file {{ ziti_router_dir }}/{{ ziti_router_name }}.jwt
      --tunneler-enabled
  when:
    - not router_cert_stat.stat.exists
    - router_list.stdout | from_json | json_query('data') | length == 0
  register: router_create

- name: Enroll router
  ansible.builtin.command:
    cmd: >
      {{ ziti_bin }} router enroll
      {{ ziti_router_dir }}/router.yaml
      --jwt {{ ziti_router_dir }}/{{ ziti_router_name }}.jwt
    creates: "{{ ziti_router_dir }}/{{ ziti_router_name }}.cert"
  when: not router_cert_stat.stat.exists

- name: Set router certificate permissions
  ansible.builtin.file:
    path: "{{ ziti_router_dir }}/{{ ziti_router_name }}.cert"
    owner: root
    group: root
    mode: '0644'
  when: router_cert_stat.stat.exists or router_create is changed

- name: Set router key permissions
  ansible.builtin.file:
    path: "{{ ziti_router_dir }}/{{ ziti_router_name }}.key"
    owner: root
    group: root
    mode: '0600'
  failed_when: false
