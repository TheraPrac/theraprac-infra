---
# =============================================================================
# Ziti Router Configuration
# =============================================================================

- name: Create router configuration
  template:
    src: router.yaml.j2
    dest: "{{ ziti_home }}/router/router.yaml"
    owner: "{{ ziti_user }}"
    group: "{{ ziti_group }}"
    mode: '0640'
  notify: restart ziti-router

- name: Check if router is enrolled
  stat:
    path: "{{ ziti_home }}/router/router.cert"
  register: router_enrolled

- name: Create router enrollment JWT
  when: not router_enrolled.stat.exists
  block:
    - name: Wait for controller to be ready
      wait_for:
        host: 127.0.0.1
        port: "{{ ziti_controller_port }}"
        timeout: 60
      ignore_errors: yes

    - name: Create router in controller
      command: >
        {{ ziti_home }}/bin/ziti edge create edge-router router-{{ environment }}
        --jwt-output-file {{ ziti_home }}/enrollments/router.jwt
        --tunneler-enabled
      environment:
        ZITI_CTRL_ADVERTISED_ADDRESS: "{{ ziti_domain }}"
        ZITI_CTRL_ADVERTISED_PORT: "{{ ziti_controller_port }}"
        ZITI_USER: admin
      become_user: "{{ ziti_user }}"
      ignore_errors: yes

    - name: Enroll router
      command: >
        {{ ziti_home }}/bin/ziti router enroll
        {{ ziti_home }}/router/router.yaml
        --jwt {{ ziti_home }}/enrollments/router.jwt
      become_user: "{{ ziti_user }}"
      ignore_errors: yes

