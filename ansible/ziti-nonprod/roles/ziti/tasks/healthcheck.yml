# =============================================================================
# Ziti Role - Health Check Tasks
# =============================================================================
# Creates a simple HTTP health check endpoint for ALB
# =============================================================================

---
- name: Create healthcheck directory
  ansible.builtin.file:
    path: "{{ ziti_healthcheck_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create healthcheck Python script
  ansible.builtin.copy:
    content: |
      #!/usr/bin/env python3
      """
      Simple HTTP health check server for ALB target health checks.
      Listens on port 8080 and responds 200 OK to all requests.
      """
      from http.server import SimpleHTTPRequestHandler, HTTPServer

      class Handler(SimpleHTTPRequestHandler):
          def do_GET(self):
              self.send_response(200)
              self.send_header('Content-Type', 'text/plain')
              self.end_headers()
              self.wfile.write(b"OK")
          
          def log_message(self, format, *args):
              # Suppress logging to reduce noise
              pass

      if __name__ == "__main__":
          server = HTTPServer(("", {{ ziti_healthcheck_port }}), Handler)
          print(f"Health check server listening on port {{ ziti_healthcheck_port }}")
          server.serve_forever()
    dest: "{{ ziti_healthcheck_dir }}/healthcheck.py"
    owner: root
    group: root
    mode: '0755'
  notify: restart healthcheck
