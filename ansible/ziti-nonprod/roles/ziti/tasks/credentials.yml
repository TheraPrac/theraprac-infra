# =============================================================================
# Ziti Role - Credential Management
# =============================================================================
# Handles admin password rotation and AWS Secrets Manager synchronization.
#
# This task file:
# 1. Reads existing password from disk (or Secrets Manager as fallback)
# 2. Optionally rotates the password
# 3. Syncs to AWS Secrets Manager
# =============================================================================

---
- name: Check if admin password file exists
  ansible.builtin.stat:
    path: "{{ ziti_admin_password_file }}"
  register: admin_password_file_stat

# Try to get password from Secrets Manager if file doesn't exist
- name: Retrieve password from Secrets Manager (fallback)
  when: not admin_password_file_stat.stat.exists
  block:
    - name: Get password from Secrets Manager
      amazon.aws.secretsmanager_secret:
        name: "{{ ziti_secrets_manager_path }}"
        state: present
      register: sm_secret
      delegate_to: localhost
      ignore_errors: true

    - name: Write password from Secrets Manager to disk
      ansible.builtin.copy:
        content: "{{ sm_secret.secret }}"
        dest: "{{ ziti_admin_password_file }}"
        owner: root
        group: root
        mode: '0600'
      when: sm_secret is success and sm_secret.secret is defined
      no_log: true

# Read password from disk
- name: Read admin password from disk
  ansible.builtin.slurp:
    src: "{{ ziti_admin_password_file }}"
  register: admin_password_content
  when: admin_password_file_stat.stat.exists or (sm_secret is defined and sm_secret is success)
  no_log: true

- name: Set admin password fact
  ansible.builtin.set_fact:
    ziti_admin_password: "{{ admin_password_content.content | b64decode | trim }}"
  when: admin_password_content is success
  no_log: true

# Password rotation (only when explicitly requested)
- name: Rotate admin password
  when: ziti_rotate_password | default(false) | bool
  block:
    - name: Generate new admin password
      ansible.builtin.set_fact:
        ziti_new_password: "{{ lookup('ansible.builtin.password', '/dev/null chars=ascii_letters,digits length=24') }}"
      no_log: true

    - name: Login to Ziti controller
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge login
          https://127.0.0.1:{{ ziti_controller_port }}
          --yes
          --username {{ ziti_admin_user }}
          --password "{{ ziti_admin_password }}"
      no_log: true
      changed_when: true

    - name: Rotate admin password in Ziti
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge update authenticator updb
          --self
          --current-password "{{ ziti_admin_password }}"
          --new-password "{{ ziti_new_password }}"
      no_log: true
      changed_when: true

    - name: Update password fact to new value
      ansible.builtin.set_fact:
        ziti_admin_password: "{{ ziti_new_password }}"
      no_log: true

    - name: Write new password to disk
      ansible.builtin.copy:
        content: "{{ ziti_admin_password }}"
        dest: "{{ ziti_admin_password_file }}"
        owner: root
        group: root
        mode: '0600'
      no_log: true

    - name: Display password rotation confirmation
      ansible.builtin.debug:
        msg: "Admin password has been rotated successfully"

# Always sync to Secrets Manager at end of run
- name: Sync admin password to AWS Secrets Manager
  amazon.aws.secretsmanager_secret:
    name: "{{ ziti_secrets_manager_path }}"
    secret: "{{ ziti_admin_password }}"
    state: present
  delegate_to: localhost
  when: ziti_admin_password is defined
  no_log: true
  tags: [secrets]



