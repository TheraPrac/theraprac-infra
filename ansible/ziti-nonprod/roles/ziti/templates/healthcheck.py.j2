#!/usr/bin/env python3
# =============================================================================
# Ziti Health Check Server
# =============================================================================
# Simple HTTP server that returns 200 OK for ALB health checks
# Checks both controller and router status
# =============================================================================

from flask import Flask, jsonify
import subprocess
import os

app = Flask(__name__)

ZITI_HOME = "{{ ziti_home }}"

def check_service_status(service_name):
    """Check if a systemd service is running"""
    try:
        result = subprocess.run(
            ["systemctl", "is-active", service_name],
            capture_output=True,
            text=True,
            timeout=5
        )
        return result.stdout.strip() == "active"
    except Exception:
        return False

@app.route('/health')
@app.route('/healthz')
@app.route('/')
def health():
    """Health check endpoint for ALB"""
    controller_healthy = check_service_status("ziti-controller")
    router_healthy = check_service_status("ziti-router")
    
    status = {
        "status": "healthy" if (controller_healthy and router_healthy) else "unhealthy",
        "controller": "running" if controller_healthy else "stopped",
        "router": "running" if router_healthy else "stopped",
    }
    
    http_code = 200 if status["status"] == "healthy" else 503
    return jsonify(status), http_code

@app.route('/ready')
def ready():
    """Readiness check"""
    controller_healthy = check_service_status("ziti-controller")
    if controller_healthy:
        return jsonify({"ready": True}), 200
    return jsonify({"ready": False}), 503

if __name__ == '__main__':
    app.run(host='0.0.0.0', port={{ ziti_health_port }}, threaded=True)





