# =============================================================================
# TheraPrac Ziti Nonprod - AWS EC2 Dynamic Inventory
# =============================================================================
# Uses the AWS EC2 plugin to discover instances and connects via SSM.
#
# Prerequisites:
#   1. Install amazon.aws collection:
#      ansible-galaxy collection install amazon.aws
#
#   2. Install boto3:
#      pip install boto3 botocore
#
#   3. Install Session Manager plugin:
#      brew install session-manager-plugin  (macOS)
#
#   4. Authenticate to AWS:
#      aws sso login --profile jfinlinson_admin
# =============================================================================

plugin: amazon.aws.aws_ec2

# AWS region
regions:
  - us-west-2

# AWS profile
profile: jfinlinson_admin

# Filter for Ziti instance
filters:
  tag:Role: ziti-server
  instance-state-name: running

# Use instance ID as hostname for SSM
hostnames:
  - instance-id

# SSM connection settings
compose:
  ansible_host: instance_id
  ansible_connection: aws_ssm
  ansible_aws_ssm_region: us-west-2
  ansible_aws_ssm_profile: jfinlinson_admin
  ansible_user: ec2-user

# Group by tags
keyed_groups:
  - key: tags.Environment
    prefix: env
  - key: tags.Role
    prefix: role
