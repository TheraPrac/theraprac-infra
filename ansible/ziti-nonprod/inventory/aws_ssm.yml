# =============================================================================
# TheraPrac Ziti Nonprod - AWS SSM Dynamic Inventory
# =============================================================================
# This inventory uses the AWS EC2 plugin to discover instances and
# connects via SSM (Systems Manager) instead of SSH.
#
# Prerequisites:
#   1. Install the amazon.aws collection:
#      ansible-galaxy collection install amazon.aws
#
#   2. Install boto3:
#      pip install boto3 botocore
#
#   3. Install Session Manager plugin:
#      brew install session-manager-plugin  (macOS)
#
#   4. Authenticate to AWS:
#      aws sso login --profile jfinlinson_admin
#
# Usage:
#   ansible-playbook -i inventory/aws_ssm.yml playbook.yml
# =============================================================================

plugin: amazon.aws.aws_ec2

# AWS region to search
regions:
  - us-west-2

# AWS profile to use (must have ec2:DescribeInstances permission)
# TODO: Update if your profile name differs
profile: jfinlinson_admin

# Filter to find only our Ziti nonprod instance
filters:
  # Match the Ansible tag we set in Terraform
  tag:Ansible: ziti-nonprod
  # Only running instances
  instance-state-name: running

# Use SSM connection instead of SSH (no need for SSH keys or bastion)
# This requires the SSM agent to be running on the instance
hostnames:
  - instance-id

# Connection settings for all hosts
compose:
  ansible_host: instance_id
  ansible_connection: aws_ssm
  ansible_aws_ssm_region: us-west-2
  ansible_aws_ssm_profile: jfinlinson_admin
  # Use ec2-user for Amazon Linux
  ansible_user: ec2-user

# Group hosts by tags for potential future use
keyed_groups:
  - key: tags.Environment
    prefix: env
  - key: tags.Role
    prefix: role

# Cache settings (optional, speeds up repeated runs)
cache: true
cache_plugin: jsonfile
cache_timeout: 300
cache_connection: /tmp/ansible_aws_ec2_cache

