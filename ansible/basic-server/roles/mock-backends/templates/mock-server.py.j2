#!/usr/bin/env python3
# =============================================================================
# Mock HTTP Server for Testing
# =============================================================================
# Managed by Ansible - DO NOT EDIT MANUALLY
#
# Simple HTTP server that responds to health checks and shows status.
# Used for testing nginx and Ziti configuration before deploying real apps.
# =============================================================================

import json
import socket
from datetime import datetime
from http.server import HTTPServer, BaseHTTPRequestHandler

PORT = {{ mock_port }}
SERVICE_NAME = "{{ mock_name }}"
SERVICE_TYPE = "{{ mock_service_type }}"

class MockHandler(BaseHTTPRequestHandler):
    """Simple HTTP handler for mock service."""
    
    def _send_json(self, status_code: int, data: dict):
        """Send JSON response."""
        self.send_response(status_code)
        self.send_header('Content-Type', 'application/json')
        self.send_header('X-Mock-Service', 'true')
        self.end_headers()
        self.wfile.write(json.dumps(data, indent=2).encode())
    
    def do_GET(self):
        """Handle GET requests."""
        hostname = socket.gethostname()
        timestamp = datetime.utcnow().isoformat() + 'Z'
        
        if self.path == '/health':
            # Health check endpoint
            self._send_json(200, {
                'status': 'healthy',
                'service': SERVICE_NAME,
                'type': SERVICE_TYPE,
                'port': PORT,
                'hostname': hostname,
                'timestamp': timestamp,
                'mock': True
            })
        
        elif self.path == '/':
            # Root endpoint
            self._send_json(200, {
                'message': f'{SERVICE_NAME} is running',
                'service': SERVICE_NAME,
                'type': SERVICE_TYPE,
                'port': PORT,
                'hostname': hostname,
                'timestamp': timestamp,
                'mock': True,
                'note': 'This is a mock service for testing. Replace with real application.'
            })
        
        elif self.path.startswith('/api/'):
            # Mock API endpoints
            self._send_json(200, {
                'message': 'Mock API response',
                'path': self.path,
                'service': SERVICE_NAME,
                'type': SERVICE_TYPE,
                'timestamp': timestamp,
                'mock': True
            })
        
        else:
            # 404 for unknown paths
            self._send_json(404, {
                'error': 'Not Found',
                'path': self.path,
                'service': SERVICE_NAME,
                'mock': True,
                'available_endpoints': ['/', '/health', '/api/*']
            })
    
    def log_message(self, format, *args):
        """Log requests to stdout."""
        print(f"[{datetime.now().isoformat()}] {self.address_string()} - {format % args}")


def main():
    """Start the mock HTTP server."""
    server = HTTPServer(('127.0.0.1', PORT), MockHandler)
    print(f"Starting {SERVICE_NAME} on port {PORT}")
    print(f"Health check: http://127.0.0.1:{PORT}/health")
    print(f"Press Ctrl+C to stop")
    
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print(f"\nShutting down {SERVICE_NAME}")
        server.shutdown()


if __name__ == '__main__':
    main()



