---
# =============================================================================
# TheraPrac API Role Tasks
# =============================================================================

- name: Validate required variables
  assert:
    that:
      - target_env is defined
      - target_env in ['dev', 'test', 'prod']
      - aws_account_id is defined
      - s3_bucket is defined
      - version is defined
    fail_msg: |
      Required variables:
        - target_env: {{ target_env | default('NOT SET') }} (must be dev, test, or prod)
        - aws_account_id: {{ aws_account_id | default('NOT SET') }}
        - s3_bucket: {{ s3_bucket | default('NOT SET') }}
        - version: {{ version | default('NOT SET') }}

# =============================================================================
# User and Directory Setup
# =============================================================================

- name: Create theraprac system group
  group:
    name: "{{ theraprac_group }}"
    system: yes
    state: present

- name: Create theraprac system user
  user:
    name: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    system: yes
    shell: /sbin/nologin
    home: "{{ theraprac_home }}"
    create_home: no
    comment: "TheraPrac API Service Account"

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'
  loop:
    - "{{ theraprac_home }}"
    - "{{ theraprac_bin_dir }}"
    - "{{ theraprac_etc_dir }}"
    - "{{ theraprac_data_dir }}"
    - "{{ theraprac_db_dir }}"

- name: Create log directory
  file:
    path: "{{ theraprac_log_dir }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'

# =============================================================================
# Tarball Deployment
# =============================================================================

- name: Detect version type
  set_fact:
    is_latest: "{{ version == 'latest' }}"
    is_branch_build: "{{ '/' in version }}"
    is_release: "{{ version != 'latest' and '/' not in version }}"

- name: Set tarball paths for main/latest
  set_fact:
    s3_tarball_path: "builds/main/latest/theraprac-api-{{ version }}-linux-arm64.tar.gz"
    s3_tarball_checksum_path: "builds/main/latest/theraprac-api-{{ version }}-linux-arm64.tar.gz.sha256"
  when: is_latest | bool

- name: Set tarball paths for branch builds
  set_fact:
    s3_tarball_path: "builds/{{ version }}/theraprac-api-0.1.0-linux-arm64.tar.gz"
    s3_tarball_checksum_path: "builds/{{ version }}/theraprac-api-0.1.0-linux-arm64.tar.gz.sha256"
  when: is_branch_build | bool

- name: Set tarball paths for releases
  set_fact:
    s3_tarball_path: "releases/v{{ version }}/theraprac-api-{{ version }}-linux-arm64.tar.gz"
    s3_tarball_checksum_path: "releases/v{{ version }}/theraprac-api-{{ version }}-linux-arm64.tar.gz.sha256"
  when: is_release | bool

- name: Get version from manifest for main/latest builds
  when: is_latest | bool
  block:
    - name: Download manifest from S3 (force fresh download)
      command: >
        aws s3 cp
        s3://{{ s3_bucket }}/builds/main/latest/manifest.json
        /tmp/theraprac-manifest-{{ ansible_hostname }}.json
        --profile jfinlinson_admin
        --region {{ aws_region }}
      delegate_to: localhost
      become: false
      changed_when: false
      # Force fresh download
      register: manifest_download

    - name: Read manifest
      slurp:
        src: "/tmp/theraprac-manifest-{{ ansible_hostname }}.json"
      register: manifest_file
      delegate_to: localhost
      become: false

    - name: Set actual version and build info from manifest
      set_fact:
        actual_version: "{{ (manifest_file.content | b64decode | from_json).version }}"
        build_commit: "{{ (manifest_file.content | b64decode | from_json).commit_short | default('unknown') }}"
        build_timestamp: "{{ (manifest_file.content | b64decode | from_json).build_timestamp | default('unknown') }}"
        build_branch: "{{ (manifest_file.content | b64decode | from_json).branch | default('unknown') }}"

    - name: Display build info being deployed
      debug:
        msg: |
          Deploying build:
            Version: {{ actual_version }}
            Commit: {{ build_commit }}
            Branch: {{ build_branch }}
            Build Time: {{ build_timestamp }}
            S3 Path: s3://{{ s3_bucket }}/builds/main/latest/

    - name: Update tarball paths with actual version
      set_fact:
        s3_tarball_path: "builds/main/latest/theraprac-api-{{ actual_version }}-linux-arm64.tar.gz"
        s3_tarball_checksum_path: "builds/main/latest/theraprac-api-{{ actual_version }}-linux-arm64.tar.gz.sha256"

- name: Get version from manifest for branch builds
  when: is_branch_build | bool
  block:
    - name: Download manifest from S3 (force fresh download)
      command: >
        aws s3 cp
        s3://{{ s3_bucket }}/builds/{{ version }}/manifest.json
        /tmp/theraprac-manifest-{{ ansible_hostname }}.json
        --profile jfinlinson_admin
        --region {{ aws_region }}
      delegate_to: localhost
      become: false
      changed_when: false
      # Force fresh download by removing any cached file first
      register: manifest_download

    - name: Read manifest
      slurp:
        src: "/tmp/theraprac-manifest-{{ ansible_hostname }}.json"
      register: manifest_file
      delegate_to: localhost
      become: false

    - name: Set actual version and build info from manifest
      set_fact:
        actual_version: "{{ (manifest_file.content | b64decode | from_json).version }}"
        build_commit: "{{ (manifest_file.content | b64decode | from_json).commit_short | default('unknown') }}"
        build_timestamp: "{{ (manifest_file.content | b64decode | from_json).build_timestamp | default('unknown') }}"
        build_branch: "{{ (manifest_file.content | b64decode | from_json).branch | default('unknown') }}"

    - name: Display build info being deployed
      debug:
        msg: |
          Deploying build:
            Version: {{ actual_version }}
            Commit: {{ build_commit }}
            Branch: {{ build_branch }}
            Build Time: {{ build_timestamp }}
            S3 Path: s3://{{ s3_bucket }}/builds/{{ version }}/

    - name: Update tarball paths with actual version
      set_fact:
        s3_tarball_path: "builds/{{ version }}/theraprac-api-{{ actual_version }}-linux-arm64.tar.gz"
        s3_tarball_checksum_path: "builds/{{ version }}/theraprac-api-{{ actual_version }}-linux-arm64.tar.gz.sha256"

- name: Set actual version for releases
  set_fact:
    actual_version: "{{ version }}"
  when: is_release | bool

- name: Download tarball checksum from S3
  command: >
    aws s3 cp
    s3://{{ s3_bucket }}/{{ s3_tarball_checksum_path }}
    /tmp/theraprac-api-{{ ansible_hostname }}.tar.gz.sha256
    --profile jfinlinson_admin
    --region {{ aws_region }}
  delegate_to: localhost
  become: false
  changed_when: false

- name: Read tarball checksum
  slurp:
    src: "/tmp/theraprac-api-{{ ansible_hostname }}.tar.gz.sha256"
  register: tarball_checksum_file
  delegate_to: localhost
  become: false

- name: Set expected tarball checksum
  set_fact:
    expected_tarball_checksum: "{{ (tarball_checksum_file.content | b64decode).split()[0] }}"

- name: Download tarball from S3 to localhost
  command: >
    aws s3 cp
    s3://{{ s3_bucket }}/{{ s3_tarball_path }}
    /tmp/theraprac-api-{{ ansible_hostname }}.tar.gz
    --profile jfinlinson_admin
    --region {{ aws_region }}
  register: tarball_download
  delegate_to: localhost
  become: false

- name: Copy tarball from localhost to remote server
  copy:
    src: "/tmp/theraprac-api-{{ ansible_hostname }}.tar.gz"
    dest: "/tmp/theraprac-api.tar.gz"
    mode: '0644'

- name: Verify tarball checksum on remote server
  stat:
    path: "/tmp/theraprac-api.tar.gz"
    checksum_algorithm: sha256
  register: tarball_stat
  failed_when: tarball_stat.stat.checksum != expected_tarball_checksum

- name: Create staging directory
  file:
    path: /tmp/theraprac-staging
    state: directory
    mode: '0755'

- name: Extract tarball
  unarchive:
    src: /tmp/theraprac-api.tar.gz
    dest: /tmp/theraprac-staging
    remote_src: yes
    extra_opts: [--strip-components=1]

- name: Clean up temporary files on localhost
  file:
    path: "{{ item }}"
    state: absent
  delegate_to: localhost
  become: false
  loop:
    - "/tmp/theraprac-api-{{ ansible_hostname }}.tar.gz"
    - "/tmp/theraprac-api-{{ ansible_hostname }}.tar.gz.sha256"
    - "/tmp/theraprac-manifest-{{ ansible_hostname }}.json"

- name: Copy binary from staging
  copy:
    src: /tmp/theraprac-staging/bin/theraprac-api
    dest: "{{ theraprac_bin_dir }}/{{ binary_name }}"
    remote_src: yes
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'
  notify: restart theraprac-api

- name: Copy database migrations from staging
  copy:
    src: /tmp/theraprac-staging/db/changelog/
    dest: "{{ theraprac_db_dir }}/changelog/"
    remote_src: yes
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0644'
    directory_mode: '0755'

- name: Copy systemd service file from staging
  copy:
    src: /tmp/theraprac-staging/deploy/systemd/theraprac-api.service
    dest: /etc/systemd/system/theraprac-api.service
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart theraprac-api

- name: Clean up staging directory
  file:
    path: /tmp/theraprac-staging
    state: absent

- name: Clean up tarball
  file:
    path: /tmp/theraprac-api.tar.gz
    state: absent

# =============================================================================
# Database Migrations
# =============================================================================

- name: Run database migrations
  when: run_migrations | bool
  block:
    - name: Get database host from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name {{ ssm_db_host_param }}
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_host
      changed_when: false

    - name: Get database port from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name {{ ssm_db_port_param }}
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_port
      changed_when: false

    - name: Get database name from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name {{ ssm_db_name_param }}
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_name
      changed_when: false

    - name: Get database admin user from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name {{ ssm_db_admin_user_param }}
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_admin_user
      changed_when: false

    - name: Get database app user from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name {{ ssm_db_user_param }}
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_user
      changed_when: false

    - name: Get database SSL mode from SSM
      ansible.builtin.command:
        cmd: >
          aws ssm get-parameter
          --name /theraprac/api/{{ target_env }}/db-ssl-mode
          --query 'Parameter.Value'
          --output text
          --region {{ aws_region }}
      register: ssm_db_ssl_mode
      changed_when: false

    - name: Get secrets from Secrets Manager
      ansible.builtin.command:
        cmd: >
          aws secretsmanager get-secret-value
          --secret-id {{ secrets_manager_secret }}
          --query 'SecretString'
          --output text
          --region {{ aws_region }}
      register: secrets_result
      no_log: true
      changed_when: false

    - name: Parse secrets JSON
      set_fact:
        db_secrets: "{{ secrets_result.stdout | from_json }}"

    - name: Display migration info
      debug:
        msg: |
          Running database migrations
          ============================
          Host: {{ ssm_db_host.stdout }}
          Port: {{ ssm_db_port.stdout }}
          Database: {{ ssm_db_name.stdout }}
          Admin User: {{ ssm_db_admin_user.stdout }}
          SSL Mode: {{ ssm_db_ssl_mode.stdout }}

    - name: Run Liquibase migrations
      command: >
        {{ liquibase_bin }}
        --changeLogFile=db.changelog-master.xml
        --url=jdbc:postgresql://{{ ssm_db_host.stdout }}:{{ ssm_db_port.stdout }}/{{ ssm_db_name.stdout }}?sslmode={{ ssm_db_ssl_mode.stdout }}
        --username={{ ssm_db_admin_user.stdout }}
        --password={{ db_secrets.DB_ADMIN_PASSWORD }}
        --liquibaseSchemaName=public
        update
      args:
        chdir: "{{ theraprac_db_dir }}/changelog"
      register: liquibase_result
      changed_when: "'successfully' in liquibase_result.stdout or 'ChangeSet' in liquibase_result.stdout"
      no_log: true
      environment:
        JAVA_HOME: /usr/lib/jvm/java-17-amazon-corretto
        DB_USER: "{{ ssm_db_user.stdout }}"
        DB_PASSWORD: "{{ db_secrets.DB_PASSWORD }}"

    - name: Display migration result
      debug:
        msg: "Database migrations completed successfully"
      when: liquibase_result.rc == 0

# =============================================================================
# Configuration
# =============================================================================

- name: Set CloudWatch log group name
  set_fact:
    cloudwatch_log_group: "/theraprac/{{ target_env }}/api"

- name: Ensure CloudWatch log group SSM parameter exists
  ansible.builtin.command:
    cmd: >
      aws ssm put-parameter
      --name /theraprac/api/{{ target_env }}/cloudwatch-log-group
      --value "{{ cloudwatch_log_group }}"
      --type String
      --overwrite
      --region {{ aws_region }}
  register: ssm_cloudwatch_result
  changed_when: "'ParameterVersion' in ssm_cloudwatch_result.stdout"
  failed_when: false

- name: Create environment file
  template:
    src: theraprac-api.env.j2
    dest: "{{ theraprac_etc_dir }}/theraprac-api.env"
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: "{{ env_file_mode }}"
  notify: restart theraprac-api

# =============================================================================
# Systemd Service
# =============================================================================

# Stop and disable mock services that may be using port 8080
- name: Check if mock-api service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/mock-api.service
  register: mock_api_service

- name: Stop and disable mock-api service
  ansible.builtin.systemd:
    name: mock-api
    state: stopped
    enabled: no
  when: mock_api_service.stat.exists
  ignore_errors: true

- name: Ensure systemd is reloaded if needed
  meta: flush_handlers

- name: Enable and start service
  systemd:
    name: "{{ service_name }}"
    enabled: yes
    state: started
  when: not ansible_check_mode

# =============================================================================
# Health Check
# =============================================================================

- name: Wait for service to be healthy
  uri:
    url: "http://localhost:8080/health"
    method: GET
    status_code: 200
  register: health_check
  retries: 30
  delay: 2
  until: health_check.status == 200
  when: not ansible_check_mode

- name: Display deployment summary
  debug:
    msg: |
      TheraPrac API Deployment Complete
      =====================================
      Environment: {{ target_env }}
      Version: {{ actual_version }}
      Binary: {{ theraprac_bin_dir }}/{{ binary_name }}
      Migrations: {{ theraprac_db_dir }}/{{ db_changelog_file }}
      Config: {{ theraprac_etc_dir }}/theraprac-api.env
      Service: {{ service_name }}
      Status: {{ 'Running' if not ansible_check_mode else 'Check mode - not started' }}
