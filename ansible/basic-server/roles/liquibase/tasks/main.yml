---
# =============================================================================
# Liquibase Installation Role
# =============================================================================
# Installs Liquibase and PostgreSQL JDBC driver for database migrations.
#
# This role:
#   1. Installs Java (OpenJDK) - required by Liquibase
#   2. Downloads Liquibase from GitHub releases
#   3. Extracts to /opt/liquibase
#   4. Downloads PostgreSQL JDBC driver
#   5. Creates symlink at /usr/local/bin/liquibase
# =============================================================================

# =============================================================================
# Install Java (Prerequisite)
# =============================================================================

- name: Check if Java is installed
  command: which java
  register: java_check
  changed_when: false
  failed_when: false

- name: Install Java (OpenJDK 17)
  ansible.builtin.dnf:
    name: java-17-amazon-corretto-headless
    state: present
  when: java_check.rc != 0

- name: Verify Java installation
  command: java -version
  register: java_version
  changed_when: false
  failed_when: false

- name: Display Java version
  debug:
    msg: "Java installed: {{ java_version.stderr_lines[0] | default('unknown') }}"
  when: java_version.rc == 0

- name: Check if Liquibase is already installed
  stat:
    path: "{{ liquibase_install_dir }}/liquibase"
  register: liquibase_installed

- name: Check installed Liquibase version
  command: "{{ liquibase_install_dir }}/liquibase --version"
  register: liquibase_current_version
  changed_when: false
  failed_when: false
  when: liquibase_installed.stat.exists
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-amazon-corretto

- name: Set Liquibase needs install flag
  set_fact:
    liquibase_needs_install: >-
      {{ not liquibase_installed.stat.exists or
         (liquibase_current_version.stdout is defined and
          liquibase_version not in liquibase_current_version.stdout) }}

- name: Create Liquibase installation directory
  file:
    path: "{{ liquibase_install_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: liquibase_needs_install

- name: Download Liquibase
  get_url:
    url: "https://github.com/liquibase/liquibase/releases/download/v{{ liquibase_version }}/liquibase-{{ liquibase_version }}.tar.gz"
    dest: "/tmp/liquibase-{{ liquibase_version }}.tar.gz"
    mode: '0644'
  when: liquibase_needs_install

- name: Extract Liquibase
  unarchive:
    src: "/tmp/liquibase-{{ liquibase_version }}.tar.gz"
    dest: "{{ liquibase_install_dir }}"
    remote_src: yes
    owner: root
    group: root
  when: liquibase_needs_install

- name: Clean up Liquibase archive
  file:
    path: "/tmp/liquibase-{{ liquibase_version }}.tar.gz"
    state: absent
  when: liquibase_needs_install

- name: Check if PostgreSQL JDBC driver exists
  stat:
    path: "{{ liquibase_install_dir }}/lib/postgresql-{{ postgres_jdbc_version }}.jar"
  register: postgres_jdbc_installed

- name: Download PostgreSQL JDBC driver
  get_url:
    url: "https://jdbc.postgresql.org/download/postgresql-{{ postgres_jdbc_version }}.jar"
    dest: "{{ liquibase_install_dir }}/lib/postgresql-{{ postgres_jdbc_version }}.jar"
    mode: '0644'
  when: not postgres_jdbc_installed.stat.exists

- name: Create Liquibase symlink
  file:
    src: "{{ liquibase_install_dir }}/liquibase"
    dest: "{{ liquibase_bin }}"
    state: link
    force: yes

- name: Verify Liquibase installation
  command: "{{ liquibase_bin }} --version"
  register: liquibase_verify
  changed_when: false
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-amazon-corretto

- name: Display Liquibase version
  debug:
    msg: "Liquibase installed: {{ liquibase_verify.stdout_lines[0] | default('unknown') }}"

