---
# =============================================================================
# TheraPrac Web Role Tasks (Standalone Build)
# =============================================================================

- name: Validate required variables
  assert:
    that:
      - target_env is defined
      - target_env in ['dev', 'test', 'prod']
      - aws_account_id is defined
      - s3_bucket is defined
      - s3_path is defined
    fail_msg: |
      Required variables:
        - target_env: {{ target_env | default('NOT SET') }} (must be dev, test, or prod)
        - aws_account_id: {{ aws_account_id | default('NOT SET') }}
        - s3_bucket: {{ s3_bucket | default('NOT SET') }}
        - s3_path: {{ s3_path | default('NOT SET') }}

# =============================================================================
# User and Directory Setup
# =============================================================================

- name: Create theraprac system group
  group:
    name: "{{ theraprac_group }}"
    system: yes
    state: present

- name: Create theraprac system user
  user:
    name: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    system: yes
    shell: /sbin/nologin
    home: "{{ theraprac_home }}"
    create_home: no
    comment: "TheraPrac Service Account"

- name: Create application directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'
  loop:
    - "{{ theraprac_home }}"
    - "{{ theraprac_web_dir }}"

- name: Create log directory
  file:
    path: "{{ theraprac_log_dir }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'

# =============================================================================
# Node.js Installation
# =============================================================================

- name: Check if Node.js binary exists
  ansible.builtin.stat:
    path: /usr/bin/node
  register: node_bin

- name: Install Node.js 20.x (Amazon Linux 2023)
  when: not node_bin.stat.exists
  block:
    - name: Download Node.js setup script
      get_url:
        url: https://rpm.nodesource.com/setup_20.x
        dest: /tmp/nodesource_setup.sh
        mode: '0755'

    - name: Run Node.js setup script
      command: bash /tmp/nodesource_setup.sh
      args:
        creates: /etc/yum.repos.d/nodesource-el9.repo

    - name: Install Node.js
      dnf:
        name: nodejs
        state: present

    - name: Clean up setup script
      file:
        path: /tmp/nodesource_setup.sh
        state: absent

- name: Get Node.js version
  command: /usr/bin/node --version
  register: node_version
  changed_when: false

- name: Set node_path fact
  set_fact:
    node_path: /usr/bin/node

- name: Display Node.js info
  debug:
    msg: "Node.js {{ node_version.stdout }} at {{ node_path }}"

# =============================================================================
# Download and Deploy Tarball
# =============================================================================

- name: Download manifest from S3
  command: >
    aws s3 cp
    s3://{{ s3_bucket }}/{{ s3_path }}/manifest.json
    /tmp/theraprac-web-manifest-{{ ansible_hostname }}.json
    --profile jfinlinson_admin
    --region {{ aws_region }}
  delegate_to: localhost
  become: false
  changed_when: false

- name: Read manifest
  slurp:
    src: "/tmp/theraprac-web-manifest-{{ ansible_hostname }}.json"
  register: manifest_file
  delegate_to: localhost
  become: false

- name: Set deployment facts from manifest
  set_fact:
    actual_version: "{{ (manifest_file.content | b64decode | from_json).version }}"
    build_env: "{{ (manifest_file.content | b64decode | from_json).environment }}"
    build_branch: "{{ (manifest_file.content | b64decode | from_json).branch }}"
    build_commit: "{{ (manifest_file.content | b64decode | from_json).commit_short }}"
    build_tag: "{{ (manifest_file.content | b64decode | from_json).tag }}"

- name: Validate environment matches
  assert:
    that:
      - build_env == target_env
    fail_msg: |
      Environment mismatch!
      Build environment: {{ build_env }}
      Target environment: {{ target_env }}
      
      You are trying to deploy a {{ build_env }} build to {{ target_env }}.
      Please use the correct build for this environment.

- name: Display deployment info
  debug:
    msg: |
      Deploying TheraPrac Web (Standalone)
      =====================================
      Tag: {{ build_tag }}
      Version: {{ actual_version }}
      Environment: {{ build_env }}
      Branch: {{ build_branch }}
      Commit: {{ build_commit }}
      S3 Path: s3://{{ s3_bucket }}/{{ s3_path }}/

- name: Set tarball name
  set_fact:
    tarball_name: "theraprac-web-{{ actual_version }}-{{ build_env }}.tar.gz"

- name: Download tarball checksum from S3
  command: >
    aws s3 cp
    s3://{{ s3_bucket }}/{{ s3_path }}/{{ tarball_name }}.sha256
    /tmp/theraprac-web-{{ ansible_hostname }}.tar.gz.sha256
    --profile jfinlinson_admin
    --region {{ aws_region }}
  delegate_to: localhost
  become: false
  changed_when: false
  ignore_errors: true
  register: checksum_download

- name: Read tarball checksum
  slurp:
    src: "/tmp/theraprac-web-{{ ansible_hostname }}.tar.gz.sha256"
  register: tarball_checksum_file
  delegate_to: localhost
  become: false
  when: checksum_download.rc == 0

- name: Set expected tarball checksum
  set_fact:
    expected_tarball_checksum: "{{ (tarball_checksum_file.content | b64decode).split()[0] }}"
  when: checksum_download.rc == 0

- name: Download tarball from S3 to localhost
  command: >
    aws s3 cp
    s3://{{ s3_bucket }}/{{ s3_path }}/{{ tarball_name }}
    /tmp/theraprac-web-{{ ansible_hostname }}.tar.gz
    --profile jfinlinson_admin
    --region {{ aws_region }}
  register: tarball_download
  delegate_to: localhost
  become: false

- name: Copy tarball from localhost to remote server
  copy:
    src: "/tmp/theraprac-web-{{ ansible_hostname }}.tar.gz"
    dest: "/tmp/theraprac-web.tar.gz"
    mode: '0644'

- name: Verify tarball checksum on remote server
  stat:
    path: "/tmp/theraprac-web.tar.gz"
    checksum_algorithm: sha256
  register: tarball_stat
  failed_when: expected_tarball_checksum is defined and tarball_stat.stat.checksum != expected_tarball_checksum
  when: checksum_download.rc == 0

- name: Create staging directory
  file:
    path: /tmp/theraprac-web-staging
    state: directory
    mode: '0755'

- name: Extract tarball
  unarchive:
    src: /tmp/theraprac-web.tar.gz
    dest: /tmp/theraprac-web-staging
    remote_src: yes

- name: Clean up temporary files on localhost
  file:
    path: "{{ item }}"
    state: absent
  delegate_to: localhost
  become: false
  loop:
    - "/tmp/theraprac-web-{{ ansible_hostname }}.tar.gz"
    - "/tmp/theraprac-web-{{ ansible_hostname }}.tar.gz.sha256"
    - "/tmp/theraprac-web-manifest-{{ ansible_hostname }}.json"

# =============================================================================
# Stop Existing Services
# =============================================================================

- name: Check if theraprac-web service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/{{ service_name }}.service
  register: service_file

- name: Stop existing systemd service
  systemd:
    name: "{{ service_name }}"
    state: stopped
  when: service_file.stat.exists

# Stop and disable mock services that may be using port 3000
- name: Check if mock-web service exists
  ansible.builtin.stat:
    path: /etc/systemd/system/mock-web.service
  register: mock_web_service

- name: Stop and disable mock-web service
  ansible.builtin.systemd:
    name: mock-web
    state: stopped
    enabled: no
  when: mock_web_service.stat.exists
  ignore_errors: true

# Cleanup PM2 if migrating from PM2-based deployment
- name: Check if PM2 is installed
  ansible.builtin.stat:
    path: /usr/bin/pm2
  register: pm2_bin

- name: Check if PM2 is installed via npm global
  ansible.builtin.stat:
    path: /usr/local/bin/pm2
  register: pm2_npm_bin

- name: Set PM2 installed fact
  set_fact:
    pm2_installed: "{{ pm2_bin.stat.exists or pm2_npm_bin.stat.exists }}"

- name: Stop PM2 theraprac-web process (migration from PM2)
  command: pm2 delete theraprac-web
  become: true
  become_user: "{{ theraprac_user }}"
  ignore_errors: true
  when: pm2_installed

# =============================================================================
# Deploy Application Files (Standalone)
# =============================================================================

- name: Backup existing web directory
  command: mv {{ theraprac_web_dir }} {{ theraprac_web_dir }}.bak.{{ ansible_date_time.epoch }}
  args:
    removes: "{{ theraprac_web_dir }}/server.js"
  ignore_errors: true

- name: Create fresh web directory
  file:
    path: "{{ theraprac_web_dir }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    mode: '0755'

# Standalone tarball extracts directly (server.js, package.json, node_modules/, .next/, public/)
# Use /. to copy all files including hidden directories like .next
- name: Copy standalone files to web directory
  ansible.builtin.shell: cp -r /tmp/theraprac-web-staging/. {{ theraprac_web_dir }}/

- name: Set ownership on web directory
  file:
    path: "{{ theraprac_web_dir }}"
    state: directory
    owner: "{{ theraprac_user }}"
    group: "{{ theraprac_group }}"
    recurse: yes

- name: Verify server.js exists
  stat:
    path: "{{ theraprac_web_dir }}/server.js"
  register: server_js_check
  failed_when: not server_js_check.stat.exists

- name: Verify .next directory exists
  stat:
    path: "{{ theraprac_web_dir }}/.next"
  register: next_dir_check
  failed_when: not next_dir_check.stat.exists

- name: Clean up staging directory
  file:
    path: /tmp/theraprac-web-staging
    state: absent

- name: Clean up tarball
  file:
    path: /tmp/theraprac-web.tar.gz
    state: absent

# =============================================================================
# Systemd Service Setup
# =============================================================================

- name: Install systemd service file
  template:
    src: theraprac-web.service.j2
    dest: /etc/systemd/system/{{ service_name }}.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart theraprac-web

- name: Ensure systemd is reloaded if needed
  meta: flush_handlers

- name: Enable and start service
  systemd:
    name: "{{ service_name }}"
    enabled: yes
    state: started
  when: not ansible_check_mode

# =============================================================================
# Health Check
# =============================================================================

- name: Wait for application to be healthy
  uri:
    url: "http://localhost:{{ web_port }}/api/health"
    method: GET
    status_code: 200
    timeout: 10
  register: health_check
  retries: 30
  delay: 2
  until: health_check.status == 200
  when: not ansible_check_mode
  ignore_errors: true

- name: Display health check result
  debug:
    msg: |
      Health check: {{ 'PASSED' if (health_check.status | default(0)) == 200 else 'FAILED - check logs' }}
      {% if health_check.json is defined %}
      Response: {{ health_check.json | to_nice_json }}
      {% endif %}
  when: not ansible_check_mode

- name: Display deployment summary
  debug:
    msg: |
      TheraPrac Web Deployment Complete (Standalone)
      ===============================================
      Environment: {{ target_env }}
      Version: {{ actual_version }}
      Tag: {{ build_tag }}
      Branch: {{ build_branch }}
      Commit: {{ build_commit }}
      Directory: {{ theraprac_web_dir }}
      Port: {{ web_port }}
      Service: {{ service_name }}
      Status: {{ 'Running' if (health_check.status | default(0)) == 200 else 'Check logs with: journalctl -u theraprac-web -n 50' }}
      
      Commands:
        systemctl status {{ service_name }}
        journalctl -u {{ service_name }} -f
