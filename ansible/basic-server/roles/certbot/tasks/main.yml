# =============================================================================
# Certbot Role - Main Tasks
# =============================================================================
# Installs certbot, requests Let's Encrypt certificates via DNS-01 challenge,
# and configures automatic renewal via systemd timer.
#
# Required variables:
#   - app_domain: Web app domain (e.g., app-dev.theraprac.com)
#   - api_domain: API domain (e.g., api-dev.theraprac.com)
#   - certbot_email: Email for Let's Encrypt notifications
#   - aws_region: AWS region for Route53
# =============================================================================

---
# =============================================================================
# Install Certbot and Route53 Plugin
# =============================================================================

- name: Install certbot and dependencies
  ansible.builtin.dnf:
    name:
      - certbot
      - python3-certbot-dns-route53
    state: present

# =============================================================================
# Check if Certificate Already Exists
# =============================================================================

- name: Check if certificate already exists
  ansible.builtin.stat:
    path: "/etc/letsencrypt/live/{{ app_domain }}/fullchain.pem"
  register: cert_exists

# =============================================================================
# Request Certificate via DNS-01 Challenge
# =============================================================================

- name: Request certificate via DNS-01 (Route53)
  ansible.builtin.command:
    cmd: >
      certbot certonly
      --dns-route53
      --non-interactive
      --agree-tos
      --email {{ certbot_email }}
      -d {{ app_domain }}
      -d {{ api_domain }}
  environment:
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  when: not cert_exists.stat.exists
  register: certbot_result
  changed_when: certbot_result.rc == 0

- name: Display certbot result
  ansible.builtin.debug:
    msg: "{{ certbot_result.stdout_lines | default(['Certificate already exists']) }}"
  when: certbot_result is defined and certbot_result.stdout_lines is defined

# =============================================================================
# Configure Automatic Renewal via Systemd Timer
# =============================================================================

- name: Create certbot renewal service
  ansible.builtin.copy:
    dest: /etc/systemd/system/certbot-renew.service
    mode: '0644'
    content: |
      [Unit]
      Description=Certbot Renewal
      Documentation=https://certbot.eff.org/docs/
      
      [Service]
      Type=oneshot
      ExecStart=/usr/bin/certbot renew --quiet --deploy-hook "systemctl reload nginx"
      Environment="AWS_DEFAULT_REGION={{ aws_region }}"
  notify: Reload systemd

- name: Create certbot renewal timer
  ansible.builtin.template:
    src: certbot-renew.timer.j2
    dest: /etc/systemd/system/certbot-renew.timer
    mode: '0644'
  notify: Reload systemd

- name: Enable and start certbot renewal timer
  ansible.builtin.systemd:
    name: certbot-renew.timer
    enabled: true
    state: started
    daemon_reload: true

# =============================================================================
# Summary
# =============================================================================

- name: Display certificate info
  ansible.builtin.debug:
    msg: |
      Certbot Certificate Configuration:
      ===================================
      Primary Domain: {{ app_domain }}
      SAN Domain:     {{ api_domain }}
      Certificate:    /etc/letsencrypt/live/{{ app_domain }}/fullchain.pem
      Private Key:    /etc/letsencrypt/live/{{ app_domain }}/privkey.pem
      Auto-Renewal:   systemctl status certbot-renew.timer

