# =============================================================================
# TheraPrac Infrastructure - Basic Server Ansible Playbook
# =============================================================================
# Registers a Ziti SSH service for a basic server.
# Called by scripts/provision-basic-server.sh after Terraform creates the EC2.
#
# Required variables (passed via -e):
#   - server_name: Full name (e.g., app.mt.nonprod)
#   - server_internal_dns: Internal DNS (e.g., app-mt-nonprod.theraprac-internal.com)
#   - ziti_ssh_name: Ziti synthetic DNS (e.g., ssh.app.mt.nonprod.ziti)
# =============================================================================

---
- name: Register Ziti SSH Service for Basic Server
  hosts: ziti-nonprod
  become: true
  vars:
    ziti_bin: /opt/ziti/bin/ziti
    ziti_controller_port: 443
    ziti_admin_user: admin

  tasks:
    # =========================================================================
    # Get Admin Password
    # =========================================================================
    
    - name: Read admin password from file
      ansible.builtin.slurp:
        src: /opt/ziti/controller/.admin_password
      register: admin_pass_b64

    - name: Set password fact
      ansible.builtin.set_fact:
        ziti_admin_password: "{{ admin_pass_b64.content | b64decode | trim }}"
      no_log: true

    # =========================================================================
    # Login to Ziti Controller
    # =========================================================================
    
    - name: Login to Ziti controller
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge login
          https://127.0.0.1:{{ ziti_controller_port }}
          --yes
          --username {{ ziti_admin_user }}
          --password "{{ ziti_admin_password }}"
      no_log: true
      changed_when: true

    # =========================================================================
    # Create Host Config
    # =========================================================================
    
    - name: Check if host config exists
      ansible.builtin.shell: |
        {{ ziti_bin }} edge list configs 'name="{{ ziti_ssh_name }}.host"' --output-json 2>/dev/null | jq -r '.data | length'
      register: host_config_count
      changed_when: false
      failed_when: false

    - name: Create host config
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge create config {{ ziti_ssh_name }}.host host.v1
          '{"protocol":"tcp", "address":"{{ server_internal_dns }}", "port":22}'
      when: host_config_count.stdout | default('0') | int == 0
      register: host_config_created

    # =========================================================================
    # Create Intercept Config
    # =========================================================================
    
    - name: Check if intercept config exists
      ansible.builtin.shell: |
        {{ ziti_bin }} edge list configs 'name="{{ ziti_ssh_name }}.intercept"' --output-json 2>/dev/null | jq -r '.data | length'
      register: intercept_config_count
      changed_when: false
      failed_when: false

    - name: Create intercept config
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge create config {{ ziti_ssh_name }}.intercept intercept.v1
          '{"protocols":["tcp"], "addresses":["{{ ziti_ssh_name }}"], "portRanges":[{"low":22, "high":22}]}'
      when: intercept_config_count.stdout | default('0') | int == 0
      register: intercept_config_created

    # =========================================================================
    # Create Service
    # =========================================================================
    
    - name: Check if service exists
      ansible.builtin.shell: |
        {{ ziti_bin }} edge list services 'name="{{ server_name }}"' --output-json 2>/dev/null | jq -r '.data | length'
      register: service_count
      changed_when: false
      failed_when: false

    - name: Create service with ssh-services role attribute
      ansible.builtin.command:
        cmd: >
          {{ ziti_bin }} edge create service {{ server_name }}
          --configs {{ ziti_ssh_name }}.host,{{ ziti_ssh_name }}.intercept
          --role-attributes ssh-services
      when: service_count.stdout | default('0') | int == 0
      register: service_created

    # =========================================================================
    # Summary
    # =========================================================================
    
    - name: Display registration results
      ansible.builtin.debug:
        msg: |
          Ziti SSH Service Registration:
          ==============================
          Server Name:    {{ server_name }}
          Internal DNS:   {{ server_internal_dns }}
          Ziti SSH Name:  {{ ziti_ssh_name }}
          
          Components:
          - Host config:      {{ 'created' if host_config_created is changed else 'exists' }}
          - Intercept config: {{ 'created' if intercept_config_created is changed else 'exists' }}
          - Service:          {{ 'created' if service_created is changed else 'exists' }}
          
          The service has role attribute #ssh-services, so existing
          ssh-bind and ssh-dial policies will automatically apply.

