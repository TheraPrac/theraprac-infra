# =============================================================================
# TheraPrac Infrastructure - Basic Server Ansible Playbook
# =============================================================================
# Provisions a basic server with Ziti tunneler for self-hosted SSH access.
# Runs ON the basic server (via EICE), not on the Ziti controller.
#
# This playbook:
#   1. Creates a Ziti identity for the server (via controller API)
#   2. Enrolls the identity on the server
#   3. Registers the SSH service (self-registration via tunneler)
#   4. Starts ziti-edge-tunnel service
#
# Required variables (passed via -e):
#   - server_name: Full name (e.g., app.mt.nonprod)
#   - ziti_ssh_name: Ziti synthetic DNS (e.g., ssh.app.mt.nonprod.ziti)
#   - ziti_identity_name: Identity name (e.g., basic-server-app-mt-nonprod)
#   - ziti_controller_endpoint: Controller URL (e.g., https://ziti-nonprod.theraprac.com)
#
# Usage:
#   ansible-playbook -i inventory/server-eice.yml playbook.yml \
#     -e "server_name=app.mt.nonprod" \
#     -e "ziti_ssh_name=ssh.app.mt.nonprod.ziti" \
#     -e "ziti_identity_name=basic-server-app-mt-nonprod" \
#     -e "ziti_controller_endpoint=https://ziti-nonprod.theraprac.com"
# =============================================================================

---
- name: Provision Basic Server with Ziti Tunneler
  hosts: basic-server
  become: true

  tasks:
    # =========================================================================
    # Role: ziti-install - Install Ziti binaries
    # =========================================================================

    - name: Include ziti-install role
      ansible.builtin.include_role:
        name: ziti-install

    # =========================================================================
    # Role: ziti-identity - Create identity on controller (via API from server)
    # =========================================================================

    - name: Include ziti-identity role
      ansible.builtin.include_role:
        name: ziti-identity

    # =========================================================================
    # Role: ziti-enroll - Enroll identity on server
    # =========================================================================

    - name: Include ziti-enroll role
      ansible.builtin.include_role:
        name: ziti-enroll

    # =========================================================================
    # Role: ziti-service - Register SSH service
    # =========================================================================

    - name: Include ziti-service role
      ansible.builtin.include_role:
        name: ziti-service

    # =========================================================================
    # Final Summary
    # =========================================================================

    - name: Display final summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          Basic Server Provisioning Complete!
          ============================================================
          
          Server:     {{ server_name }}
          Identity:   {{ ziti_identity_name }}
          
          SSH Access via Ziti:
            ssh jfinlinson@{{ ziti_ssh_name }}
          
          SSH Access via EICE (break-glass):
            aws ec2-instance-connect ssh --instance-id <id> --os-user jfinlinson --connection-type eice
          
          Service Status:
            systemctl status ziti-edge-tunnel@{{ ziti_identity_name }}
          
          Logs:
            tail -f /opt/ziti/logs/{{ ziti_identity_name }}.log
          ============================================================
